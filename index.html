<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal Video Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Pulse animation for the recording indicator */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-active {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center py-4 px-4 font-sans text-slate-800">

    <!-- Header -->
    <header class="text-center mb-4 md:mb-6">
        <h1 class="text-2xl md:text-4xl font-bold text-slate-800 mb-1">Universal Recorder</h1>
        <p class="text-slate-500 text-xs md:text-base">Record Screen or Camera</p>
    </header>

    <!-- Main Controller Card -->
    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- Video Preview Area -->
        <div class="relative bg-black aspect-video flex items-center justify-center group overflow-hidden bg-slate-900">
            <!-- transform scale-x-[-1] mirrors the camera for a more natural feel, handled in JS -->
            <video id="videoPreview" class="w-full h-full object-contain" autoplay muted playsinline></video>
            
            <!-- Placeholder State -->
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-4 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 md:h-20 md:w-20 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <p class="text-sm md:text-lg">Select source below</p>
            </div>

            <!-- Recording Indicator (Hidden by default) -->
            <div id="recordingIndicator" class="hidden absolute top-4 right-4 flex items-center gap-2 bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-full text-white text-xs md:text-sm font-medium z-10">
                <div class="w-2 h-2 md:w-3 md:h-3 bg-red-500 rounded-full recording-active"></div>
                <span id="timer">00:00</span>
            </div>
        </div>

        <!-- Controls Toolbar -->
        <div class="p-4 md:p-6 flex flex-col md:flex-row items-center justify-between gap-4 border-t border-slate-100">
            
            <!-- Settings / Status -->
            <div class="w-full md:w-auto flex flex-col md:flex-row gap-3 items-center">
                
                <!-- Source Selector -->
                <div class="relative w-full md:w-48">
                    <select id="sourceSelect" class="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-700 py-3 px-4 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm font-medium cursor-pointer">
                        <option value="screen">Record Screen</option>
                        <option value="camera">Record Camera</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                
                <span id="statusMessage" class="hidden md:block text-slate-500 text-sm font-medium">Ready</span>
            </div>

            <!-- Action Buttons -->
            <div class="w-full md:w-auto flex gap-3 justify-center md:justify-end">
                
                <button id="startBtn" class="w-full md:w-auto flex justify-center items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Start
                </button>

                <button id="stopBtn" disabled class="hidden w-full md:w-auto flex justify-center items-center gap-2 px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />
                    </svg>
                    Stop
                </button>

                <a id="downloadBtn" class="hidden w-full md:w-auto flex justify-center items-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 cursor-pointer active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Save
                </a>
            </div>
            
            <!-- Mobile Status Message (Below buttons on mobile) -->
            <div class="md:hidden text-center w-full">
                 <span id="mobileStatusMessage" class="text-slate-500 text-xs font-medium px-2 block">Ready</span>
            </div>
        </div>
    </main>

    <!-- Info Section -->
    <footer class="mt-6 text-center text-slate-400 text-xs max-w-lg mx-auto px-4">
        <p class="mb-2"><strong>Android Users:</strong> To record screen, this page must be hosted on a website (HTTPS), not opened as a local file.</p>
        <p><strong>iOS Users:</strong> Web screen recording is blocked by Apple. Use "Record Camera" or the Control Center.</p>
    </footer>

    <script>
        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const videoPreview = document.getElementById('videoPreview');
        const statusMessage = document.getElementById('statusMessage');
        const mobileStatusMessage = document.getElementById('mobileStatusMessage');
        const placeholder = document.getElementById('placeholder');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const timerDisplay = document.getElementById('timer');
        const sourceSelect = document.getElementById('sourceSelect');

        // State variables
        let mediaRecorder;
        let recordedChunks = [];
        let timerInterval;
        let startTime;

        // Configuration
        const mimeTypes = [
            'video/webm;codecs=vp9,opus',
            'video/webm;codecs=vp8,opus',
            'video/webm',
            'video/mp4'
        ];

        // UI Helpers
        function updateStatus(msg, isError = false) {
            statusMessage.textContent = msg;
            mobileStatusMessage.textContent = msg;
            if (isError) {
                statusMessage.classList.add('text-red-500');
                mobileStatusMessage.classList.add('text-red-500');
                // Shake animation for mobile error visibility
                mobileStatusMessage.classList.add('animate-pulse');
                setTimeout(() => mobileStatusMessage.classList.remove('animate-pulse'), 2000);
            } else {
                statusMessage.classList.remove('text-red-500');
                mobileStatusMessage.classList.remove('text-red-500');
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                timerDisplay.textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplay.textContent = "00:00";
        }

        function getSupportedMimeType() {
            for (const type of mimeTypes) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }
            return '';
        }

        // Main Function: Start Recording
        async function startRecording() {
            try {
                updateStatus("Requesting access...");
                const mode = sourceSelect.value;
                let stream;

                if (mode === 'screen') {
                    // SCREEN RECORDING LOGIC
                    try {
                        // Check if function exists (older mobiles lack this)
                        if (!navigator.mediaDevices?.getDisplayMedia) {
                            throw new Error("Screen recording is not supported by this browser. Try Chrome on Android.");
                        }

                        stream = await navigator.mediaDevices.getDisplayMedia({
                            video: {
                                mediaSource: 'screen'
                                // removed 'displaySurface' constraint to be more mobile-friendly
                            },
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false,
                                sampleRate: 48000,
                                channelCount: 2
                            },
                            systemAudio: "include" 
                        });
                        // Remove mirror effect for screen share
                        videoPreview.style.transform = "scaleX(1)";
                    } catch (err) {
                        console.error("Screen Rec Error:", err);
                        
                        // Detailed Mobile Error Handling
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        
                        if (isMobile && (location.protocol === 'file:' || location.protocol === 'content:')) {
                            throw new Error("Android blocks screen recording from local files. Upload this file to a website.");
                        }
                        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                            throw new Error("iOS does not support web screen recording. Use 'Record Camera' or System Control Center.");
                        }
                        if (err.name === 'NotAllowedError') {
                            throw new Error("Permission denied. You must select a screen to share.");
                        }
                        
                        throw err; // Re-throw generic error if specific ones didn't match
                    }

                } else {
                    // CAMERA RECORDING LOGIC (Mobile Friendly)
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "user", // Default to front camera
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: {
                            echoCancellation: true, // Better for voice
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    // Mirror the camera for natural feel
                    videoPreview.style.transform = "scaleX(-1)";
                }

                // UI Updates
                startBtn.classList.add('hidden');
                sourceSelect.disabled = true;
                stopBtn.classList.remove('hidden');
                stopBtn.disabled = false;
                downloadBtn.classList.add('hidden');
                placeholder.classList.add('hidden');
                recordingIndicator.classList.remove('hidden');
                updateStatus("Recording...");
                
                videoPreview.srcObject = stream;
                videoPreview.muted = true; 
                videoPreview.play();

                // Initialize MediaRecorder
                const mimeType = getSupportedMimeType();
                // We use high bitrate for screen, slightly lower/standard for camera to ensure stability
                const options = {
                    mimeType: mimeType || undefined,
                    audioBitsPerSecond: 128000, 
                    videoBitsPerSecond: mode === 'screen' ? 2500000 : 1500000
                };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    console.warn('Fallback to default MediaRecorder settings');
                    mediaRecorder = new MediaRecorder(stream);
                }

                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    finalizeRecording();
                };

                // If user stops sharing via browser UI
                stream.getVideoTracks()[0].onended = () => {
                    if (mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                };

                mediaRecorder.start(1000);
                startTimer();

            } catch (err) {
                console.error("Error starting recording:", err);
                
                let errorMsg = "Error: " + err.message;
                if (err.name === 'NotAllowedError' && err.message.includes('permissions policy')) {
                    errorMsg = "Preview Blocked: Download and open locally.";
                }
                
                updateStatus(errorMsg, true);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            const stream = videoPreview.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                videoPreview.srcObject = null;
            }
        }

        function finalizeRecording() {
            stopTimer();
            recordingIndicator.classList.add('hidden');
            
            const blob = new Blob(recordedChunks, {
                type: mediaRecorder.mimeType || 'video/webm'
            });

            const url = URL.createObjectURL(blob);
            
            videoPreview.srcObject = null;
            videoPreview.src = url;
            videoPreview.muted = false;
            videoPreview.controls = true;
            // Un-mirror for playback regardless of source
            videoPreview.style.transform = "scaleX(1)"; 
            videoPreview.play();

            stopBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
            sourceSelect.disabled = false;
            
            // Refine "Record Again" button
            startBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a1 1 0 01-1.5.866l-2.5-1.5a1 1 0 010-1.732l2.5-1.5A1 1 0 014 2z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M11.5 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1h-6a1 1 0 01-1-1V8zm-5-3a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1V6a1 1 0 00-1-1H6.5z" clip-rule="evenodd" />
                </svg>
                Record Again
            `;
            
            downloadBtn.classList.remove('hidden');
            downloadBtn.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadBtn.download = `recording-${timestamp}.webm`;

            updateStatus("Recording finished!");
        }

        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);
    </script>
</body>
</html>
